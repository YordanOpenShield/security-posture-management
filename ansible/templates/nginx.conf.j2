worker_processes auto;
events { worker_connections 1024; }

http {
	sendfile on;
	tcp_nopush on;
	tcp_nodelay on;
	keepalive_timeout 65;
	types_hash_max_size 2048;

	include /etc/nginx/mime.types;
	default_type application/octet-stream;

	# upstream Faraday application
	upstream faraday_upstream {
		server {{ upstream_host | default('127.0.0.1') }}:{{ upstream_port | default(5985) }} fail_timeout=5s;
	}
    upstream faraday_ws_upstream {
        server {{ upstream_host | default('127.0.0.1') }}:{{ upstream_ws_port | default(9000) }} fail_timeout=5s;
	}

	server {
		listen 80;
		server_name _;

		# Increase upload limits if Faraday may receive file uploads
		client_max_body_size {{ client_max_body_size | default('100M') }};

		# Proxy settings
		location / {
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
			proxy_set_header X-Forwarded-Host $host;
			proxy_set_header X-Forwarded-Port $server_port;

			proxy_http_version 1.1;
			proxy_set_header Connection "";
			proxy_buffering off;

			proxy_connect_timeout {{ proxy_connect_timeout | default('5s') }};
			proxy_send_timeout    {{ proxy_send_timeout | default('60s') }};
			proxy_read_timeout    {{ proxy_read_timeout | default('60s') }};

			proxy_pass http://faraday_upstream;
		}

		# Logging
		access_log /var/log/nginx/faraday_access.log;
		error_log  /var/log/nginx/faraday_error.log warn;
	}
}
