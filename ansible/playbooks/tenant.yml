- name: Deploy Faraday stack to tenant host
  hosts: tenant
  become: true
  gather_facts: yes

  vars:
    compose_dir: /opt/faraday
    pg_user: faraday
    pg_db: faraday

  tasks:

    - name: render docker-compose.yml
      template:
        src: templates/docker-compose.yml.j2
        dest: "{{ compose_dir }}/docker-compose.yml"
        owner: 1000
        group: 1000
        mode: "0644"
      vars:
        pg_user: "{{ pg_user }}"
        pg_password: "{{ pg_password }}"
        pg_db: "{{ pg_db }}"
        rmq_user: "{{ rmq_user }}"
        rmq_password: "{{ rmq_password }}"

    - name: render nginx.conf.j2
      template:
        src: templates/nginx.conf.j2
        dest: "{{ compose_dir }}/nginx.conf"
        owner: 1000
        group: 1000
        mode: "0644"

    - name: add Docker GPG key
      ansible.builtin.apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present
        keyring: /etc/apt/keyrings/docker.asc

    - name: add Docker repo
      apt_repository:
        repo: 'deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}") stable'
        state: present

    - name: install docker engine
      apt:
        name: [docker-ce, docker-ce-cli, containerd.io, docker-buildx-plugin, docker-compose-plugin]
        state: latest
        update_cache: yes

    - name: start compose
      shell: docker compose -f docker-compose.yml up -d
      args:
        chdir: "{{ compose_dir }}"